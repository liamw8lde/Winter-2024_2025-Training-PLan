
ğŸ“‹ SANITY CHECK â€“ Winter Training (Iterative Audit + Repair)

You are my auditor and repairer. Run a FULL audit, repair all resolvable violations, and REâ€‘AUDIT repeatedly until the plan is stable (no new violations) or only flagged UNREPAIRABLE items remain. Repeat up to 100 passes if necessary.

PARAMETERS (read first)
- INPUT FILE: One Excel/CSV file (the plan). Use ONLY this file + the rules below. No external data.
- FROZEN WEEKS (optional): If I provide ISO weeks to freeze (e.g., {year:2025, weeks:[38]}), do NOT modify matches that occur in those ISO weeks; still AUDIT them and report violations.
- STABILITY: After every repair pass you MUST re-run the full audit. Repeat until stable or max 100 passes.
- PRIORITY: HARD rules must be satisfied before any SOFT advisories. If a conflict cannot be solved without breaking another HARD rule, mark as UNREPAIRABLE (do not delete the row).

------------------------------------------------------------
HOW TO PARSE THE PLAN
1) Prefer the sheet named â€œSpielplanâ€.
2) If missing, reconstruct from the â€œHerren 40â€“50â€“60â€ grid:
   - For each row (date), group players by identical slot code; emit one row per group.
   - Typ = Einzel if headcount = 2, otherwise Doppel if headcount = 4.
3) Slot code is valid iff it matches:
   ^([DE])(\d{2}):(\d{2})-([0-9]+)\s+PL([AB])$
4) Headcount expectations: Einzel = 2, Doppel = 4.
5) Compute ISO week (Year + Week) from Datum for weekly rules and coverage.
6) Normalize player names to a canonical set (trim, collapse spaces, unify ÃŸ/ss, umlauts, and case).

------------------------------------------------------------
ALLOWED SLOTS (STRICT) â€” â€œweekday + code + court + durationâ€ must match exactly
- Montag
  - D20:00-120 PLA â€” Doppel
  - D20:00-120 PLB â€” Doppel
- Mittwoch
  - E18:00-60 PLA â€” Einzel (note: PLB at 18:00 is illegal)
  - E19:00-60 PLA â€” Einzel
  - E19:00-60 PLB â€” Einzel
  - D20:00-90 PLA â€” Doppel
  - D20:00-90 PLB â€” Doppel
- Donnerstag
  - E20:00-90 PLA â€” Einzel
  - E20:00-90 PLB â€” Einzel

WEEKLY COVERAGE (STRICT)
- For EACH ISO week, every allowed weekday/slot combination above must appear EXACTLY ONCE.
- Missing or duplicate required slots = violation `weekly_coverage`.

------------------------------------------------------------
GLOBAL TIME RULES (HARD)
- No starts after 20:00 (e.g., 20:30 illegal).
- Wednesday doubles must be exactly 20:00 for 90 min.
- Duration/court must match the slot code exactly.

------------------------------------------------------------
PROTECTED PLAYERS (HARD)
- Patrick Buehrsch â†’ 18:00 only.
- Frank Petermann â†’ only 19:00 or 20:00 (never 18:00).
- Matthias Duddek â†’ only 18:00 or 19:00 (never â‰¥20:00).
- Dirk Kistner â†’ Mo/Mi/Do only; on Wednesday only 19:00 (never 18:00 or 20:00); max 2/week.
- Arndt Stueber â†’ only Wednesday 19:00.
- Thommy/Thomas Grueneberg â†’ start 18:00 or 19:00 70% of the time; 30% Wednesday 20:00.
- Jens Hafner â†’ only Wednesday 19:00.

WOMEN & SINGLES (HARD)
- Women (Anke Ihde, Lena Meiss, Martina Schmidt, Kerstin Baarck) must NOT play singles.
- Any female in singles = violation `womens_singles` (mixed singles included).

------------------------------------------------------------
MONDAY CORE SLOT (HARD) â€” Montag D20:00â€“120 PLA
1) Mandatory Core:
   - Martin Lange and Bjoern Junker must always be present unless on holiday.
   - The other two players must be chosen ONLY from {Frank Petermann, Lars Staubermann, Peter Plaehn}, rotated evenly across the season.
2) Exclusions:
   - No women ever (except: Lena Meiss allowed ONLY if Liam Wilde is also one of the four).
   - Mohamad Albadry is NEVER allowed.
   - No other substitutes allowed (e.g., Tobias Kahl, Gunnar Brix, etc.).
3) Holiday Exception:
   - If >1 core player is missing and not on holiday â†’ violation `mon_pla_core` (flag UNREPAIRABLE if no legal fill).
   - Do not fill with outsiders unless explicitly permitted above.
4) Enforcement Order:
   - Enforce this rule BEFORE any other repairs for that row; a row passing other checks but failing this must be repaired again.

------------------------------------------------------------
ONE-PER-DAY (HARD)
- A player may not appear more than once per calendar date.

WEEKLY CAPS / SEASON CAPS (HARD unless specified)
- Weekly caps:
  - Tobias Kahl: max 1/week
  - Dirk Kistner: max 2/week
  - Torsten Bartel: max 1/week
- Season caps:
  - Torsten Bartel: max 5/season
  - Frank Petermann: max 12/season (Monday PLA still counts toward this cap)

------------------------------------------------------------
HOLIDAYS / BLACKOUTS (AUTHORITATIVE)
- Use ONLY the list below for holiday checks (prompt wins on overlap).
- Monday PLA core exemption: in that slot ONLY, the core four are exempt from holiday checks (caps still apply).
- Global blackouts: NO matches on **24.12**, **25.12**, **31.12** (any year covered by the plan).

<<START MERGED HOLIDAYS LIST>>
- Andreas Dank: 2015-12-24 â†’ 2015-12-26; 2015-12-31 â†’ 2016-01-01.
- Anke Ihde: 2025-09-25.
- Arndt Stueber: 2025-10-16 â†’ 2025-11-03; 2025-11-13 â†’ 2025-11-24; 2025-12-11 â†’ 2025-12-31.
- Bernd Robioneck: 2025-12-01 â†’ 2025-12-08; 2025-12-22 â†’ 2026-01-04.
- Bernd Sotzek: 2025-01-01 â†’ 2026-01-04.
- Bjoern: 2025-10-25; 2025-10-31; 2025-12-20; 2025-12-31.
- Bjoern Junker: 2025-10-25 â†’ 2025-10-31; 2025-12-20 â†’ 2025-12-31.
- Carsten Gambal: 2025-09-29 â†’ 2025-10-10; 2025-11-12 â†’ 2025-11-13; 2025-12-24 â†’ 2026-01-01.
- Dirk Kistner: 2025-09-18 â†’ 2025-09-22; 2025-10-02; 2025-10-30; 2025-12-22 â†’ 2025-12-31.
- Frank Koller: 2025-10-10 â†’ 2025-10-31; 2025-12-18 â†’ 2026-01-05.
- Frank Petermann: 2025-09-08 â†’ 2025-09-14; 2025-10-13 â†’ 2025-10-25; 2025-12-01 â†’ 2025-12-07; 2025-12-24; 2025-12-31.
- Gunnar Brix: 2025-09-01 â†’ 2025-09-26; 2025-10-06 â†’ 2025-10-11; 2025-10-20 â†’ 2025-10-25; 2025-11-17 â†’ 2025-11-22; 2025-12-22 â†’ 2025-12-31.
- Heiko Thomsen: 2025-09-15 â†’ 2025-10-10; 2025-11-12; 2025-12-03; 2025-12-17; 2025-12-22 â†’ 2025-12-26; 2025-12-31.
- Jan Pappenheim: No holidays.
- Jens Hafner: 2025-10-23 â†’ 2025-11-02; 2025-12-24 â†’ 2025-12-26.
- Jens Krause: 2025-09-24 â†’ 2025-09-24.
- Joerg: 2025-12-22; 2026-01-02.
- Joerg Peters: 2025-12-22 â†’ 2026-01-02.
- Juergen: 2025-12-22; 2026-01-04.
- Juergen Hansen: 2025-12-22 â†’ 2026-01-04.
- Kai Schroeder: 2025-10-06 â†’ 2025-10-12; 2025-12-01 â†’ 2025-12-06; 2025-12-22 â†’ 2025-12-27; 2026-01-19 â†’ 2026-01-31.
- Karsten: 2025-11-12 â†’ 2025-11-13; 2025-12-24; 2025-12-29.
- Karsten Usinger: 2025-09-01 â†’ 2025-11-03; 2025-12-22 â†’ 2025-12-29; 2025-12-31.
- Kerstin Baarck: 2025-09-01 â†’ 2025-10-31.
- Lars Staubermann: 2025-10-06 â†’ 2025-10-26; 2026-03-23 â†’ 2026-04-12.
- Lena Meiss: 2025-01-01 â†’ 2025-09-20; 2025-10-01 â†’ 2025-10-31.
- Liam Wilde: 2025-12-24.
- Lorenz Kramp: 2025-10-04 â†’ 2025-10-24.
- Manfred Grell: 2025-09-22; 2025-10-06.
- Markus Muench: 2025-10-13 â†’ 2025-10-19; 2025-12-22 â†’ 2026-01-04.
- Martin Lange: 2025-12-22 â†’ 2026-01-04.
- Martina Schmidt: 2025-11-08 â†’ 2025-11-22; 2026-01-01.
- Matthias Duddek: 2025-11-04 â†’ 2025-11-10; 2025-12-24 â†’ 2025-12-31.
- Meiss: 2025-01-01 â†’ 2025-09-20.
- Michael Bock: 2025-12-20 â†’ 2026-01-04.
- Michael Rabehl: 2025-10-09 â†’ 2025-10-12.
- Mohamad Albadry: No holidays.
- Muench: 2025-10-13; 2025-10-19; 2025-12-22; 2026-01-04.
- Oliver Boess: 2025-09-01 â†’ 2025-09-30; 2025-12-01 â†’ 2025-12-07; 2025-12-24 â†’ 2025-12-25.
- Patrick Buehrsch: 2025-11-01 â†’ 2025-11-30.
- Peter Plaehn: No holidays.
- Ralf Colditz: 2025-09-08 â†’ 2025-09-30; 2025-12-22 â†’ 2026-01-03.
- Schroeder: 2025-10-06; 2025-10-12; 2025-12-01; 2025-12-06; 2025-12-22; 2025-12-27.
- Sebastian Braune: 2025-10-20 â†’ 2025-10-30; 2025-12-28 â†’ 2026-01-06.
- Stueber: 2025-10-16; 2025-10-31; 2025-11-17; 2025-11-23; 2025-12-15; 2025-12-31.
- Thomas Bretschneider: No holidays.
- Thomas Grueneberg: No holidays.
- Tobias Kahl: 2025-09-01 â†’ 2025-09-14; 2025-09-23 â†’ 2025-10-09; 2025-10-20 â†’ 2025-10-31; 2025-12-22 â†’ 2025-12-31.
- Torsten Bartel: 2025-09-15 â†’ 2025-09-24; 2025-09-29 â†’ 2025-10-15; 2025-10-20 â†’ 2025-10-23; 2025-10-29 â†’ 2025-11-19; 2025-11-24 â†’ 2025-12-17; 2025-12-22 â†’ 2025-12-25.
- Wolfgang Aleksik: 2025-09-01 â†’ 2025-09-16; 2025-09-18 â†’ 2025-10-14; 2025-10-16 â†’ 2025-10-21; 2025-10-23 â†’ 2025-11-04; 2025-11-06 â†’ 2025-11-11; 2025-11-13 â†’ 2025-11-25; 2025-11-27 â†’ 2025-12-09; 2025-12-11 â†’ 2025-12-31.
<<END MERGED HOLIDAYS LIST>>

------------------------------------------------------------
WEEKDAY AVAILABILITY (JOTFORM)
- Use the list below when not overridden by â€œProtected Playersâ€ or explicit prompt rules.

<<START JOTFORM WEEKDAY AVAILABILITY LIST>>
- Andreas Dank: Montag, Mittwoch
- Anke Ihde: Montag, Mittwoch, Donnerstag
- Arndt StÃ¼ber/Stueber: Mittwoch
- Bernd Robioneck: Mittwoch, Donnerstag
- Bernd Sotzek: Montag, Mittwoch
- Bjoern Junker: Montag
- Carsten Gambal: Montag, Mittwoch, Donnerstag
- Dirk Kistner: Montag, Mittwoch, Donnerstag
- Frank Koller: Mittwoch, Donnerstag
- Frank Petermann: Montag, Mittwoch, Donnerstag
- Gunnar Brix: Montag, Mittwoch, Donnerstag
- Heiko Thomsen: Mittwoch
- Jan Pappenheim: Montag, Mittwoch, Donnerstag
- Jens Hafner: Montag, Mittwoch
- Jens Krause: Mittwoch
- Joerg/JÃ¶rg Peters: Mittwoch
- Juergen/JÃ¼rgen Hansen: Mittwoch
- Kai Schroeder/SchrÃ¶der: Mittwoch
- Karsten Usinger: Mittwoch, Donnerstag
- Kerstin Baarck: Montag, Donnerstag
- Lars Staubermann: Montag, Donnerstag
- Lena Meiss/MeiÃŸ: Montag, Donnerstag
- Liam Wilde: Montag, Donnerstag
- Lorenz Kramp: Montag, Mittwoch
- Manfred Grell: Mittwoch, Donnerstag
- Markus Muench/MÃ¼nch: Mittwoch, Sonntag
- Martin Lange: Montag
- Martina Schmidt: Montag, Mittwoch, Donnerstag
- Matthias Duddek: Montag, Mittwoch, Donnerstag
- Michael Bock: Montag, Mittwoch
- Michael Rabehl: Montag, Donnerstag
- Mohamad Albadry: Montag
- Oliver Boess/BÃ¶ss: Mittwoch, Donnerstag
- Patrick Buehrsch: Mittwoch, Donnerstag
- Peter Plaehn/PlÃ¤hn: Montag
- Ralf Colditz: Mittwoch
- Sebastian Braune: Montag, Donnerstag
- Thomas Bretschneider: Donnerstag
- Thomas Grueneberg/GrÃ¼neberg: Mittwoch, Donnerstag
- Tobias Kahl: Montag, Mittwoch
- Torsten Bartel: Montag, Mittwoch, Donnerstag
- Wolfgang Aleksik: Mittwoch
<<END JOTFORM WEEKDAY AVAILABILITY LIST>>

------------------------------------------------------------
PLAYER RANKS (AUTHORITATIVE)
- 1 = strongest â€¦ 6 = weakest. If missing, treat as unknown (skip rank checks) and emit parsing warning.

<<START PLAYER RANKS>>
- Andreas Dank: 5
- Anke Ihde: 6
- Arndt Stueber: 4
- Bernd Robioneck: 4
- Bernd Sotzek: 3
- Bjoern Junker: 1
- Carsten Gambal: 4
- Dirk Kistner: 5
- Frank Koller: 4
- Frank Petermann: 2
- Gunnar Brix: 6
- Heiko Thomsen: 4
- Jan Pappenheim: 5
- Jens Hafner: 6
- Jens Krause: 2
- Joerg Peters: 2
- Juergen Hansen: 3
- Kai Schroeder: 4
- Karsten Usinger: 5
- Kerstin Baarck: 6
- Lars Staubermann: 2
- Lena Meiss: 6
- Liam Wilde: 2
- Lorenz Kramp: 4
- Manfred Grell: 4
- Markus Muench: 5
- Martin Lange: 2
- Martina Schmidt: 6
- Matthias Duddek: 3
- Michael Bock: 6
- Michael Rabehl: 6
- Mohamad Albadry: 5
- Oliver Boess: 3
- Patrick Buehrsch: 1
- Peter Plaehn: 2
- Ralf Colditz: 4
- Sebastian Braune: 6
- Thomas Bretschneider: 2
- Thomas Grueneberg: 2
- Tobias Kahl: 5
- Torsten Bartel: 5
- Wolfgang Aleksik: 6
<<END PLAYER RANKS>>

------------------------------------------------------------
RANK RULES
- Singles Rank Window (HARD): for players A,B in singles, |rank[A] âˆ’ rank[B]| â‰¤ 2, else violation `singles_rank_window`.
- Doubles Balance (HARD): with ranks sorted r1 â‰¤ r2 â‰¤ r3 â‰¤ r4, violation `doubles_balance` if ANY of:
  (a) The strongest player rank r1 > 3 (i.e., r1 must be 1, 2, or 3)
  (b) Rank spread r4 âˆ’ r1 > 3 (maximum allowed range is 3, e.g., 1-4, 2-5, 3-6)
  (c) Neither of the following balanced pairing patterns holds:
      i)  Similar quartet: r4 âˆ’ r1 â‰¤ 2, OR
      ii) Two-strong vs two-weak: (r2 âˆ’ r1 â‰¤ 1) AND (r4 âˆ’ r3 â‰¤ 1) AND (r3 âˆ’ r2 â‰¥ 2)

------------------------------------------------------------
REPAIR ENGINE (do this AFTER first audit, then iterate)
GENERAL PRINCIPLES
- Never edit rows in FROZEN WEEKS.
- Prefer swaps and minimal movement across the SAME ISO week to satisfy weekly coverage.
- Do not delete rows. If unsolvable without breaking a HARD rule â†’ append â€œ(UNREPAIRABLE)â€ to Spieler and keep the row.
- Maintain headcount and slot legality at all times.
- After EACH repair pass, re-run the FULL AUDIT over the entire file.

REPAIR PRIORITY ORDER (apply in this order)
1) Illegal slot codes / wrong weekday-duration-court â†’ fix to nearest legal slot or flag UNREPAIRABLE if ambiguous.
2) Headcount wrong (Einzelâ‰ 2, Doppelâ‰ 4) â†’ adjust by adding/removing legal players.
3) Monday core slot violations â†’ enforce core roster/exclusions strictly.
4) Holidays/blackouts (except core exemption) â†’ replace with legal, available players.
5) Protected player time rules â†’ move/replace to legal times.
6) One-per-day â†’ de-duplicate a player across same date by swapping with legal alternates.
7) Weekly coverage (missing/duplicate required slots) â†’ fix within week where possible.
8) Weekly & season caps â†’ re-balance assignments without breaking earlier HARD rules.
9) Singles rank window (HARD) â†’ re-pair players; if impossible, flag UNREPAIRABLE.
10) Doubles balance (HARD) â†’ re-arrange players to satisfy: r1â‰¤3, r4âˆ’r1â‰¤3, and balanced pairings; if impossible, flag UNREPAIRABLE.

TIEBREAKERS (deterministic)
- Prefer replacements from players already available that week and allowed by weekday availability.
- For Monday core rotation, cycle through {Frank, Lars, Peter} to equalize appearances.
- When multiple legal options exist, choose the alphabetically first surname to keep deterministic output.

ITERATION
- Perform: AUDIT â†’ REPAIR â†’ AUDIT â€¦ until:
  - No violations remain (other than SOFT advisories), OR
  - Only rows marked UNREPAIRABLE remain, OR
  - Max passes reached (100).

------------------------------------------------------------
OUTPUT (at the very end, after convergence)
A) Sanity Summary (compact JSON integers):
   - headcount_errors; illegal_slot_codes; starts_after_20_00; wed_doubles_not_20_00;
   - protected_time_violations; womens_singles; mixed_singles;
   - weekday_conflicts; holiday_conflicts;
   - only_doubles_in_singles; only_singles_in_doubles;
   - weekly_cap_violations; season_cap_violations;
   - overlaps_same_day; dirk_rules_violations;
   - mon_pla_mohamad; mon_pla_woman; mon_pla_core;
   - missing_required_weekly_slots;
   - kerstin_target {player, planned_total, target=6, shortfall};
   - singles_rank_window;
   - doubles_balance.

B) Violations table (+ downloadable CSV):
   Columns: Datum | Tag | Slot | Typ | Spieler | Betroffene/r | Regel | Details
   - Include â€œ0 violationsâ€ if none.
   - Rows flagged UNREPAIRABLE must appear here with explanation.

C) Per-player weekly usage & caps (+ CSV):
   Spieler | Jahr | KW | Matches_in_KW | Cap | Over_Cap(Yes/No)

D) Helpful tables (optional):
   - Singles roster; Doubles roster; Players with >1 appearance on same date; Kerstin target check.
   - List of `doubles_balance` violations with player ranks.

E) Corrected Plan (CSV):
   - Same layout/columns as input. 
   - For UNREPAIRABLE items, append â€œ(UNREPAIRABLE)â€ to Spieler.

PARSING WARNINGS
- Report unreadable slot codes, unknown names, inconsistent date formats, unknown ranks.

IMPORTANT
- Do NOT modify the uploaded file in place â€” create a new corrected CSV.
- Use ONLY this prompt + the uploaded plan.
- All date logic uses ISO weeks.
